---
layout: post
title: "第十三届NXP智能车赛小记(一)"
date: 2018-08-13
description: "记录、反思与探索"
tag: 技术 
---   
 
    18年三月，有幸与歌神、伟哥还有浩哥组队一起参加将在七月举办的第十三届NXP智能车竞赛三轮电磁组。参赛队伍由隔壁实验室的楷哥发起，除了无线节能组无人参加之外，我们与其他小伙伴开始了为期三个月的脱发之旅。   
    
    后轮驱动，差速转弯，前轮是万向轮作为从动轮，控制小车沿着一条通有20Hz方波信号的导线行进竞速，导线电流为100±20mA，赛道元素有圆环、Q型弯、U型弯、十字弯、S弯、坡道和颠簸，这是三轮电磁组的参赛规则简介，和二轮直立组有着很多的相似之处，于是又和直立的三位盆友结下了深厚的友谊。   
    
<br/>    
<br/> 

  ###  原理实现   
    控制原理说起来非常简单，导线中通有交变电流信号，在周围空间中产生磁场，利用电感线圈、霍尔元件检测空间中某一点的磁场强弱，根据毕奥-萨筏尔定律，估算该点相对于导线的位置关系，测量车身周围磁场强弱，进而推算出车体与导线的位置和姿态，利用后轮差速，实现小车行进转弯等控制，使小车沿着导线前行。   
    （以上每一句话（如果逗点分隔也算一句的话），都至少一个坑，心累啊。）   
    
  ###  整车方案设计
    方案设计中，最重要的就是磁场信号检测部分，这是小车的“眼睛”。有霍尔元件和电感两大类，霍尔元件可直接检测磁场强弱信号，但是可供使用的型号不多，在赛场电磁情况下，大多数检测距离非常进（<5cm），或者是开关式检测（0 1两种状态），不满足要求。于是选择的基于电感的检测方案：电感+谐振选频+运放。电机驱动选用双向控制的双路驱动，采用编码器进行测速，积分可得行驶的路程，采用mpu6050检测角加速度，积分可得转动的角度but容易漂移软件上需单独处理。车体布局上，双路电机驱动和5V稳压电路在同一块板子上，主控芯片、各传感器的接口，OLED/按键等，信号检测部分的运放电路放在另一块板子上，考虑到电机工作过程中对电流的影响，稳压电路中需要做隔离从避免干扰到运放电路，两块板子上下放置，置于车体中央靠后的位置，电池置于后轮后侧，使整车重心落在后轮轴绍往前一点，避免加速时车体抬头。   
    
  ###  电路设计
    由于LM358和OPA2350两款运放芯片在使用上的相似性，我们采用LM358做前期电路设计，电路验证可用后换OPA芯片（主要是因为穷），然后微调。运放电路的pcb布局、布线以及供电需要特别注意，对放大效果和放大质量影响很大。我们将信号放大到900mV左右（车身姿态正常的情况下的最大值），贴着导线放置时可以到2.6V左右，这样对坡道的检测和圆环的判断有一定的便利性。电机驱动我们抄了一块红薯的板子，基于BTN7971的，5v稳压也是淘宝上一个常见的方案，电流负载力不大但是给车上的5v设备供电还是足够的。   
    
   ###  软件设计
    前期设计中，打算用陀螺仪检测角度做角度反馈来控制转向，但是后来调不出mpu6050硬解的四元数，软解的话，芯片运算速率又跟不上影响控制周期，故而放弃，说一下最后比赛用的方案吧。整体的处理流程大致如下：ad采集 -> 20次递推加权滤波 -> 差比和 -> pd方向闭环（算出两轮的差速用于转向） -> pid速度闭环（车车转弯速度和基本速度融合） -> 输出PWM给电机驱动。利用中电感进行圆环、十字弯等元素判断，当满足条件时直接控制方向环。在中断中进行车车模式选择便于现场灵活设置。在中断中进行起跑线检测实现停车功能。
    
    将两个电感的采集值经过20次递推加权滤波，是为了使车车的方向控制更加柔和稳定，避免因一两次电感采集值的跳变使车车急转弯跑飞。 滤波之后做差比和运算，可以得出车车相对于导线的方向偏移量（正负可判断左右偏移，值的大小可判断偏移的距离，0为沿中线），将此值作为误差进行pd控制，从而实现方向闭环。
    
    
 <br/>    
<br/> 
<br/>    
   以上为我们队的技术概要，或者称之为控制思路，这是已经优化了的最终上场的方案，但是其中有很多理想化的地方，而这些地方无一例外，都变成了坑等着我们去跳。在爬坑的过程中，有些坑被我们填平了；有一些，我们换了一个思路绕过了；而还有的坑，我们一路带到了赛场上，所以，你或许曾注意到，有一台车，带着坑在赛道上“疾驰”。   
   以上，谨作为简略的技术回顾，有很多坑，有很多调车趣闻，也有很多比赛故事，未完待续......

   
 
 
　　
